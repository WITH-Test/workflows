name: 'DogeOps : Build image'

on:
  workflow_call:
    inputs:
      runs-on:
        description: 'Platform to execute on'
        required: false
        type: string
        default: 'ubuntu-latest'
      project-folder:
        description: 'The folder containing the project to build'
        required: false
        type: string
        default: '.'
      container_registry:
        description: 'defaults to ghcr. supports dockerhub and ecr'
        required: false
        type: string
        default: 'ghcr'
      container_repository_uri:
        description: "in case of Docker Hub: username/image-name"
        required: false
        type: string
        default: ''
      AWS_REGION:
        description: "in case of AWS ECR"
        required: false
        type: string
        default: 'eu-west-3'

    secrets:
      container_registry_username:
        description: 'Username for container registry'
        required: false
      container_registry_password:
        description: 'Password for container registry'
        required: false
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false

jobs:
  build:
    permissions:
      contents: read
      packages: write  # Push
    runs-on: ${{ inputs.runs-on }}
    steps:
    - name: Checkout repo
      uses: actions/checkout@v3

    - name: Get repository accesses
      id: get-repo
      run: |
        REPO=""
        USERNAME=""
        PASSWORD=""
        if [ ${{ inputs.container_registry }} = 'ghcr' ]; then
          REPO=$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')
          USERNAME=${{ github.actor }}
          PASSWORD=${{ secrets.GITHUB_TOKEN }}
        elif [ ${{ inputs.container_registry }} = 'ecr' ]; then
          REPO=${{ inputs.container_repository_uri }}
        else
          REPO=${{ inputs.container_repository_uri }}
          USERNAME=${{ secrets.container_registry_username }}
          PASSWORD=${{ secrets.container_registry_password }}
        fi
        # suffix the repo if building other than cwd
        if [ ${{ inputs.project-folder }} != '.' ]; then
          REPO=$REPO-${{ inputs.project-folder }}
        fi

        echo "::set-output name=repo::$REPO"
        echo "::set-output name=username::$USERNAME"
        echo "::set-output name=password::$PASSWORD"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1

    - name: Login to Container Registry
      if: inputs.container_registry != 'ecr'
      uses: docker/login-action@v1
      with:
        registry: ${{ inputs.container_registry }}
        username: ${{ steps.get-repo.outputs.username }}
        password: ${{ steps.get-repo.outputs.password }}

    - name: Configure AWS credentials
      if: inputs.container_registry == 'ecr'
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ inputs.AWS_REGION }}

    - name: Login to Amazon ECR
      if: inputs.container_registry == 'ecr'
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v1

    - name: Generate tags and image meta
      id: meta
      uses: docker/metadata-action@v3
      with:
        images: |
           ${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}
        tags: |
          type=ref,event=tag
          type=sha

    - name: Build image
      uses: docker/build-push-action@v2
      with:
        context: ${{ inputs.project-folder }}
        load: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=registry,ref=${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}:latest
        cache-to: type=registry,ref=${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}:latest,mode=max

    - name: Analyze image efficiency
      uses: MartinHeinz/dive-action@v0.1.3
      if: false
      with:
        image: '${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}:${{ steps.meta.outputs.version }}'
        config: ${{ inputs.DIVE_CONFIG }}
        exit-zero: ${{ !inputs.ENFORCE_DIVE }}

    # The results of this scan should be pushed to GH security, but that's not free
    - name: Trivy vulnerability scan
      if: false
      uses: aquasecurity/trivy-action@master
      id: image-scan
      with:
        image-ref: '${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}:${{ steps.meta.outputs.version }}'
        format: 'sarif'
        output: 'trivy-results.sarif'

    - name: Push container image
      uses: docker/build-push-action@v2
      with:
        context: ${{ inputs.project-folder }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        cache-from: type=registry,ref=${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}:latest
        cache-to: type=registry,ref=${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}:latest,mode=max

    # run this only for prod
    # every image sign needs user intervention
    - name: Install cosign
      uses: sigstore/cosign-installer@main
      if: ${{ github.ref_type == 'tag' }}

    - name: Sign the published image
      if: ${{ github.ref_type == 'tag' }}
      env:
        COSIGN_EXPERIMENTAL: "true"
      run: cosign sign ${{ inputs.container_registry }}/${{ steps.get-repo.outputs.repo }}:${{ steps.meta.outputs.version }}